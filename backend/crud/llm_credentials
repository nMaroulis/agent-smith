from sqlalchemy.orm import Session
from backend.models.llm_credentials import LLMCredential
from backend.core.encryption import fernet_encrypt, fernet_decrypt


def create_llm_credential(db: Session, provider: str, name: str, api_key: str):
    cred = LLMCredential(provider=provider, name=name)
    cred.set_api_key(api_key)
    db.add(cred)
    db.commit()
    db.refresh(cred)
    return cred


def get_llm_credentials(db: Session):
    return db.query(LLMCredential).all()


def update_llm_credential(db: Session, cred_id: int, provider: str, name: str, api_key: str):
    cred = db.query(LLMCredential).filter(LLMCredential.id == cred_id).first()
    if not cred:
        raise HTTPException(status_code=404, detail="LLM Credential not found")
    cred.provider = provider
    cred.name = name
    cred.set_api_key(api_key)
    db.commit()
    db.refresh(cred)
    return cred


def delete_llm_credential(db: Session, cred_id: int):
    cred = db.query(LLMCredential).filter(LLMCredential.id == cred_id).first()
    if not cred:
        raise HTTPException(status_code=404, detail="LLM Credential not found")
    db.delete(cred)
    db.commit()
    return cred

